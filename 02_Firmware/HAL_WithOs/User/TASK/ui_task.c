/**
  ******************************************************************************
  * @file    ui_task.c
  * @author  少年潜行(snqx-lgh)
  * @version V
  * @date    2025-1-28
  * @brief   这部分是小车界面显示部分，使用的是U8G2图形库，会根据选择的对象显示对应
			 的相关信息。
			 这部分的代码，参考了B站的up小蛋显璐  https://www.bilibili.com/video/BV1xd4y1C7BE
  ******************************************************************************
  * @attention
  *
  *
  * <h2><center>&copy; Copyright {Year} LQH,China</center></h2>
  ******************************************************************************
  */
#include "ui_task.h"

#include "bsp_led.h"
#include "bsp_key.h"

#include "filter.h"
#include "bsp_adc.h"
#include "hc_sr04.h"
 
#include "control_task.h" 
 
#include "u8g2.h"
#include "u8g2_stm32_port.h"

const uint8_t control[] U8X8_PROGMEM = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0x01,0x00,0x00,0x00,0xF0,
    0x01,0x00,0x00,0x00,0xF0,0x01,0x00,0x00,0x00,0xFF,0xFD,0xFF,0xFF,0x0F,0xFF,0xFD,
    0xFF,0xFF,0x0F,0xFF,0xFD,0xFF,0xFF,0x0F,0xF0,0x01,0x00,0x00,0x00,0xF0,0x01,0x00,
    0x00,0x00,0xF0,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0x00,0x00,0x00,0x00,0x0F,0x00,0x00,
    0xFF,0xFF,0xCF,0xFF,0x0F,0xFF,0xFF,0xCF,0xFF,0x0F,0xFF,0xFF,0xCF,0xFF,0x0F,0xFF,
    0xFF,0xCF,0xFF,0x0F,0x00,0x00,0x0F,0x00,0x00,0x00,0x00,0x0F,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x7C,0x00,0x00,0x00,0x00,0x7C,0x00,0xFE,0xFF,0xFF,0x7F,
    0x07,0xFF,0xFF,0xFF,0x7F,0x0F,0xFF,0xFF,0xFF,0x7F,0x0F,0xFF,0xFF,0xFF,0x7F,0x0F,
    0x00,0x00,0x00,0x7C,0x00,0x00,0x00,0x00,0x7C,0x00,0x00,0x00,0x00,0x7C,0x00,0x00,
    0x00,0x00,0x00,0x00,/*"D:\Project\Stm32BalanceCar\03_Tools\control.bmp",0*/
};

const uint8_t wifi[] U8X8_PROGMEM = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFC,
    0xFF,0x0F,0x00,0x00,0xFC,0xFF,0x0F,0x00,0xC0,0x3F,0xC0,0xFF,0x00,0xC0,0x3F,0xC0,
    0xFF,0x00,0xF0,0x03,0x00,0xF0,0x03,0xF0,0x03,0x00,0xF0,0x03,0x30,0xF0,0xFF,0x03,
    0x03,0x30,0xF0,0xFF,0x03,0x03,0x00,0xFF,0xFF,0x0F,0x00,0x00,0xFF,0xFF,0x0F,0x00,
    0xC0,0x0F,0x00,0x3C,0x00,0xC0,0x0F,0x00,0x3C,0x00,0x00,0x00,0x3F,0x00,0x00,0x00,
    0x00,0x3F,0x00,0x00,0x00,0xF0,0xFF,0x03,0x00,0x00,0xF0,0xFF,0x03,0x00,0x00,0xF0,
    0xC0,0x03,0x00,0x00,0xF0,0xC0,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x3F,0x00,0x00,0x00,0x00,0x3F,0x00,0x00,0x00,0x00,0x3F,0x00,
    0x00,0x00,0x00,0x3F,0x00,0x00,0x00,0x00,0x0C,0x00,0x00,0x00,0x00,0x0C,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,/*"D:\Project\Stm32BalanceCar\03_Tools\WIFI.bmp",0*/
};

const uint8_t sys[] U8X8_PROGMEM = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0xF0,0xFF,0x03,0x00,0x00,0xF0,0xFF,0x03,0x00,0x00,0xFF,
    0xFF,0x0F,0x00,0x00,0xFF,0xFF,0x0F,0x00,0xC0,0x0F,0x00,0x3F,0x00,0xC0,0x0F,0x00,
    0x3F,0x00,0xC0,0x03,0x00,0xFC,0x00,0xC0,0x03,0x00,0xFC,0x00,0xF0,0x00,0x0F,0xF0,
    0x00,0xF0,0x00,0x0F,0xF0,0x00,0xF0,0x00,0x00,0xC0,0x03,0xF0,0x00,0x00,0xC0,0x03,
    0xF0,0x00,0x0F,0xC0,0x03,0xF0,0x00,0x0F,0xC0,0x03,0xF0,0x00,0x0F,0xC0,0x03,0xF0,
    0x00,0x0F,0xC0,0x03,0xF0,0x00,0x0F,0xC0,0x03,0xF0,0x00,0x0F,0xC0,0x03,0xF0,0x00,
    0x0F,0xF0,0x03,0xF0,0x00,0x0F,0xF0,0x03,0xF0,0x03,0x0F,0xF0,0x00,0xF0,0x03,0x0F,
    0xF0,0x00,0xC0,0x0F,0x00,0xFC,0x00,0xC0,0x0F,0x00,0xFC,0x00,0x00,0x3F,0xC0,0x3F,
    0x00,0x00,0x3F,0xC0,0x3F,0x00,0x00,0xFC,0xFF,0x0F,0x00,0x00,0xFC,0xFF,0x0F,0x00,
    0x00,0xC0,0xFF,0x00,0x00,0x00,0xC0,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,/*"D:\Project\Stm32BalanceCar\03_Tools\info.bmp",0*/
};

/**
  * @brief   界面缓慢移动到目标位置 
  * @param    
  * @retval
 **/
int16_t ui_run(int16_t *a,int16_t *a_trg)
{
	int16_t speed = 0;
	
	// 根据差值确定速度值
    if (*a - *a_trg > 5) {
        speed = 4;
    } else if (*a - *a_trg > -5) {
        speed = 1;
    } else {
        speed = 4;
    }
	
    if(*a < *a_trg)
    {
        *a += speed;
    }
    else if( *a > *a_trg)
    {
        *a -= speed;    
    }
    else
    {
        return 0;
    }
    return 1;
}

/**
  * @brief   显示角度、电量、距离等信息
  * @param    
  * @retval
 **/
void Draw_Control_info(int16_t control_x,int16_t control_y)
{
	static uint16_t count = 0;
	float power = 0;
	adc_convert();           
	power = get_power_value() ;
 	count ++;
	if(count%10 == 0)
		trig_send_pluse();
    u8g2_SetFont(&u8g2, u8g2_font_8x13_tf);
    uint8_t data_info[20];
    sprintf((char*)data_info,"angle:%.2f",get_car_angle());
    u8g2_DrawStr(&u8g2, control_x , control_y+16, (const char*)data_info);  
    sprintf((char*)data_info,"dis:%d mm",get_hcsr04_mm());
    u8g2_DrawStr(&u8g2, control_x , control_y+32, (const char*)data_info);
    sprintf((char*)data_info,"power:%.2f",power);
    u8g2_DrawStr(&u8g2, control_x , control_y+48, (const char*)data_info);
}

/**
  * @brief   显示WIFI相关信息 
  * @param    
  * @retval
 **/
void Draw_Wifi_info(int16_t wifi_x,int16_t wifi_y)
{
    u8g2_SetFont(&u8g2, u8g2_font_8x13_tf);
    uint8_t data_info[20];
    sprintf((char*)data_info,"wifi setting");
    u8g2_DrawStr(&u8g2, wifi_x , wifi_y+16, (const char*)data_info);  
    sprintf((char*)data_info,"ip:192.168.4.1");
    u8g2_DrawStr(&u8g2, wifi_x , wifi_y+32, (const char*)data_info);  
    sprintf((char*)data_info,"tcp port:333");
    u8g2_DrawStr(&u8g2, wifi_x , wifi_y+48, (const char*)data_info);  
}

/**
  * @brief   显示系统相关信息 
  * @param    
  * @retval
 **/
void Draw_Sys_info(int16_t sys_x,int16_t sys_y)
{
	u8g2_SetFont(&u8g2, u8g2_font_8x13_tf);
    uint8_t data_info[20];
    sprintf((char*)data_info,"author:snqx-lqh");
    u8g2_DrawStr(&u8g2, sys_x , sys_y+16, (const char*)data_info);  
    sprintf((char*)data_info,"version:v1.0");
    u8g2_DrawStr(&u8g2, sys_x , sys_y+32, (const char*)data_info);  
    sprintf((char*)data_info,"Thank You");
    u8g2_DrawStr(&u8g2, sys_x , sys_y+48, (const char*)data_info);  
}

void ui_task(void const * argument)
{	
	uint8_t keyValue = 0;   //按键按下的值
	
	int8_t  menu_ui_pos = 0;     //用来确认现在是选中的第几个
    int8_t  menu_ui_state = 0;   //判断现在是菜单界面还是信息界面

    int16_t menu_ui_left_x = 46,menu_ui_left_y = 15;
    int16_t menu_ui_left_x_target = 46,menu_ui_left_y_target = 15;

    int16_t control_info_x = 0,control_info_y = 64;
    int16_t control_info_y_target = 64;

    int16_t wifi_info_x = 0,wifi_info_y = 64;
    int16_t wifi_info_y_target = 64;

    int16_t sys_info_x = 0,sys_info_y = 64;
    int16_t sys_info_y_target = 64;
	
	hc_sr04_init();
	u8g2Init(&u8g2);
	u8g2_SetFont(&u8g2, u8g2_font_8x13_tf);
	
	while(1)
	{
//		u8g2_FirstPage(&u8g2);
//		do {
			u8g2_ClearBuffer(&u8g2); 
			u8g2_DrawStr(&u8g2, 20 , menu_ui_left_y-5, "balance car");  
            u8g2_DrawXBMP(&u8g2, menu_ui_left_x      , menu_ui_left_y, 36, 36, control);
            u8g2_DrawXBMP(&u8g2, menu_ui_left_x + 50 , menu_ui_left_y, 36, 36, wifi);
            u8g2_DrawXBMP(&u8g2, menu_ui_left_x + 100, menu_ui_left_y, 36, 36, sys);

            Draw_Control_info(control_info_x,control_info_y);
            Draw_Wifi_info(wifi_info_x,wifi_info_y);
            Draw_Sys_info(sys_info_x,sys_info_y);

            ui_run(&menu_ui_left_x,&menu_ui_left_x_target);
            ui_run(&menu_ui_left_y,&menu_ui_left_y_target);

            ui_run(&control_info_y,&control_info_y_target);
            ui_run(&wifi_info_y   ,&wifi_info_y_target);
            ui_run(&sys_info_y    ,&sys_info_y_target);
			u8g2_SendBuffer(&u8g2);
		//} while (u8g2_NextPage(&u8g2));
		 
		if(KEY_Message_Queue!=NULL)
        {
			xQueueReceive(KEY_Message_Queue,&keyValue,0);
		}
		
		if(keyValue == 1)
		{
			if(menu_ui_state == 0)
            {
				//在菜单界面下按下按键1，修改选择对象，将全体左移，如果移到了最后，又返回到最开始
                menu_ui_pos ++;
                if(menu_ui_pos > 2)
                {
                    menu_ui_left_x_target = 46;
                    menu_ui_pos = 0;
                }    
                else
                    menu_ui_left_x_target -= 50;  
            }else if(menu_ui_state == 1)
            {
				//在信息界面下按下按键1，根据当前位置，选择移动的目标对象
                menu_ui_state = 0;
                menu_ui_left_y_target += 64;
                if(menu_ui_pos == 0)
                {
                    control_info_y_target += 64;
                }    
                else if(menu_ui_pos == 1)
                {
                    wifi_info_y_target += 64;
                }
                else if(menu_ui_pos == 2)
                {
                    sys_info_y_target += 64;
                }
            } 
		}else if(keyValue == 2)
		{
			if(menu_ui_state == 0)
            {
				//在菜单界面下按下按键2，根据选择对象，设置信息界面
                menu_ui_state = 1;
                menu_ui_left_y_target -= 64;
                if(menu_ui_pos == 0)
                {
                    control_info_y_target -= 64;
                }    
                else if(menu_ui_pos == 1)
                {
                    wifi_info_y_target -= 64;
                }
                else if(menu_ui_pos == 2)
                {
                    sys_info_y_target -= 64;
                }
            } 
		}
		keyValue = 0;
		vTaskDelay(100);
	}
}


 
 
